name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      - name: Pull latest code
        run: |
          set -euo pipefail
          cd /opt/the_rawcodders
          git reset --hard origin/main
          git pull origin main

      - name: Deploy Infrastructure
        run: |
          set -euo pipefail
          cd "/opt/the_rawcodders/The RawCodders"

          # 1. Stop existing services cleanly
          sudo docker compose --env-file .env.local down --remove-orphans
          
          # 2. Start backend first and wait for it to be healthy
          sudo docker compose --env-file .env.local up -d --wait backend

          # 3. Sync Env AND Deploy Convex in ONE container run
          sudo docker compose --env-file .env.local run --rm convex-deploy sh -lc '
          set -euo pipefail

          # ---- Sync Convex Env Vars ----
          node - <<'"'"'NODE'"'"'
          const fs = require("fs");

          function parseEnv(path) {
            const txt = fs.readFileSync(path, "utf8");
            const out = {};
            let i = 0;

            while (i < txt.length) {
              while (i < txt.length && (txt[i] === "\n" || txt[i] === "\r")) i++;
              if (i >= txt.length) break;
              if (txt[i] === "#") { while (i < txt.length && txt[i] !== "\n") i++; continue; }

              let key = "";
              while (i < txt.length && /[A-Za-z0-9_]/.test(txt[i])) key += txt[i++];
              while (i < txt.length && (txt[i] === " " || txt[i] === "\t")) i++;

              if (txt[i] !== "=") { while (i < txt.length && txt[i] !== "\n") i++; continue; }
              i++;
              while (i < txt.length && (txt[i] === " " || txt[i] === "\t")) i++;

              let val = "";
              if (txt[i] === "\"") {
                i++;
                while (i < txt.length) {
                  if (txt[i] === "\"" && txt[i - 1] !== "\\") { i++; break; }
                  val += txt[i++];
                }
              } else {
                while (i < txt.length && txt[i] !== "\n" && txt[i] !== "\r") val += txt[i++];
                val = val.trim();
              }

              if (key) out[key] = val;
              while (i < txt.length && txt[i] !== "\n") i++;
            }
            return out;
          }

          (async () => {
            const env = parseEnv("/app/.env.local");
            const base = process.env.CONVEX_SELF_HOSTED_URL;
            const adminKey = process.env.CONVEX_SELF_HOSTED_ADMIN_KEY;

            for (const k of ["SITE_URL", "JWT_PRIVATE_KEY", "JWKS"]) {
              if (!env[k] || env[k].length === 0) throw new Error(`Missing ${k} in .env.local`);
            }
            if (!base) throw new Error("Missing CONVEX_SELF_HOSTED_URL");
            if (!adminKey) throw new Error("Missing CONVEX_SELF_HOSTED_ADMIN_KEY");

            const res = await fetch(`${base}/api/v1/update_environment_variables`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Convex ${adminKey}`,
              },
              body: JSON.stringify({
                changes: [
                  { name: "SITE_URL", value: env.SITE_URL },
                  { name: "JWT_PRIVATE_KEY", value: env.JWT_PRIVATE_KEY },
                  { name: "JWKS", value: env.JWKS },
                ],
              }),
            });

            if (!res.ok) {
              console.error("Failed:", res.status, await res.text());
              process.exit(1);
            }
            console.log("âœ… Convex env vars synced.");
          })().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

          # ---- Deploy Convex Functions ----
          # Switched to npm install with caching flags instead of strict ci
          npm install --prefer-offline --no-audit --no-fund
          npx convex deploy --yes --url $CONVEX_SELF_HOSTED_URL --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY

          # ---- Seed Database ----
          echo "Seeding database..."
          npx convex run seed:seedClients --url $CONVEX_SELF_HOSTED_URL --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY
          '

          # 4. Bring up the remaining services (frontend & dashboard) and build if needed
          sudo docker compose --env-file .env.local up -d --build
