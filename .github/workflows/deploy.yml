name: Deploy

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: self-hosted

    steps:
      - uses: actions/checkout@v4

      # 1. Detect which folders changed in this push
      - name: Check for changed files
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            core:
              - 'The RawCodders/**'
            ai:
              - 'ai-service/**'

      # 2. Pull the latest code on the server
      - name: Pull latest code
        run: |
          set -euo pipefail
          cd /opt/the_rawcodders
          git fetch origin main
          git reset --hard origin/main
          git clean -fd

      # 3. Deploy Core App (Only runs if files inside 'The RawCodders' changed)
      - name: Deploy Core Infrastructure (Frontend, Backend, Convex)
        if: steps.filter.outputs.core == 'true'
        run: |
          set -euo pipefail
          cd "/opt/the_rawcodders/The RawCodders"

          # Start backend first and wait for it to be healthy
          sudo docker compose --env-file .env.local up -d --build --wait backend

          # Sync Env AND Deploy Convex in ONE container run
          sudo docker compose --env-file .env.local run --rm convex-deploy sh -lc '
          set -euo pipefail

          # ---- Sync Convex Env Vars ----
          node - <<'"'"'NODE'"'"'
          const fs = require("fs");

          function parseEnv(path) {
            const txt = fs.readFileSync(path, "utf8");
            const out = {};
            let i = 0;

            while (i < txt.length) {
              while (i < txt.length && (txt[i] === "\n" || txt[i] === "\r")) i++;
              if (i >= txt.length) break;
              if (txt[i] === "#") { while (i < txt.length && txt[i] !== "\n") i++; continue; }

              let key = "";
              while (i < txt.length && /[A-Za-z0-9_]/.test(txt[i])) key += txt[i++];
              while (i < txt.length && (txt[i] === " " || txt[i] === "\t")) i++;

              if (txt[i] !== "=") { while (i < txt.length && txt[i] !== "\n") i++; continue; }
              i++;
              while (i < txt.length && (txt[i] === " " || txt[i] === "\t")) i++;

              let val = "";
              if (txt[i] === "\"") {
                i++;
                while (i < txt.length) {
                  if (txt[i] === "\"" && txt[i - 1] !== "\\") { i++; break; }
                  val += txt[i++];
                }
              } else {
                while (i < txt.length && txt[i] !== "\n" && txt[i] !== "\r") val += txt[i++];
                val = val.trim();
              }

              if (key) out[key] = val;
              while (i < txt.length && txt[i] !== "\n") i++;
            }
            return out;
          }

          (async () => {
            const env = parseEnv("/app/.env.local");
            const base = process.env.CONVEX_SELF_HOSTED_URL;
            const adminKey = process.env.CONVEX_SELF_HOSTED_ADMIN_KEY;

            for (const k of ["SITE_URL", "JWT_PRIVATE_KEY", "JWKS"]) {
              if (!env[k] || env[k].length === 0) throw new Error(`Missing ${k} in .env.local`);
            }
            if (!base) throw new Error("Missing CONVEX_SELF_HOSTED_URL");
            if (!adminKey) throw new Error("Missing CONVEX_SELF_HOSTED_ADMIN_KEY");

            const res = await fetch(`${base}/api/v1/update_environment_variables`, {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Convex ${adminKey}`,
              },
              body: JSON.stringify({
                changes: [
                  { name: "SITE_URL", value: env.SITE_URL },
                  { name: "JWT_PRIVATE_KEY", value: env.JWT_PRIVATE_KEY },
                  { name: "JWKS", value: env.JWKS },
                ],
              }),
            });

            if (!res.ok) {
              console.error("Failed:", res.status, await res.text());
              process.exit(1);
            }
            console.log("âœ… Convex env vars synced.");
          })().catch((e) => {
            console.error(e);
            process.exit(1);
          });
          NODE

          # ---- Deploy Convex Functions ----
          npm install --prefer-offline --no-audit --no-fund
          npx convex deploy --yes --url $CONVEX_SELF_HOSTED_URL --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY

          # ---- Seed Database ----
          echo "Seeding database..."
          npx convex run seed:seed --url $CONVEX_SELF_HOSTED_URL --admin-key $CONVEX_SELF_HOSTED_ADMIN_KEY
          '

          # Bring up the remaining frontend & dashboard services
          sudo docker compose --env-file .env.local up -d --build frontend dashboard

      # 4. Deploy AI Service (Only runs if files inside 'ai-service' changed)
      - name: Deploy AI Microservice
        if: steps.filter.outputs.ai == 'true'
        run: |
          set -euo pipefail
          # We run this from "The RawCodders" directory because that is where docker-compose.yml lives
          cd "/opt/the_rawcodders/The RawCodders"
          
          # Force rebuild and startup of ONLY the AI service
          sudo docker compose --env-file .env.local up -d --build ai-service